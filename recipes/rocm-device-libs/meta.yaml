{% set name = "rocm-device-libs" %}
{% set version = "7.0.1" %}
{% set llvm_major_version = "20" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/ROCm/llvm-project/archive/refs/tags/rocm-{{ version }}.zip
  sha256: 8ec2abbadd6ac93b66f0e6db8d7624676958470f96c1693c1ed8c2069b74fe9a
  patches:
    - patches/0001-fix-install-path.patch

build:
  number: 0
  skip: true  # [not linux]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ stdlib('c') }}
    # Workaround for https://github.com/ROCm/llvm-project/commit/a18cc4c7cb51f94182b6018c7c73acde1b8ebddb
    - cmake <4
    - make
  host:
    - rocm-core {{ version }}
    - rocm-cmake
    - zlib
    - clangdev {{ llvm_major_version }}.*
    - llvmdev {{ llvm_major_version }}.*
    - llvm

test:
  requires:
    - clangdev {{ llvm_major_version }}.*
    - llvmdev {{ llvm_major_version }}.*
    - lld {{ llvm_major_version }}.*
    - compiler-rt {{ llvm_major_version }}.*
    - clang-tools {{ llvm_major_version }}.*
  files:
    - test/hip_smoke_test.hip
  commands:
    # Check files are in the expected location
    - test -f $PREFIX/lib/clang/{{ llvm_major_version }}/lib/amdgcn/bitcode/hip.bc
    # Test that clang can find the bitcode files out of the box
    - clang -x hip -nogpuinc -c ./test/hip_smoke_test.hip -o ./test/hip_smoke_test.o

about:
  home: https://github.com/ROCm/ROCm-Device-Libs
  license: NCSA
  license_family: MIT
  license_file: LICENSE.TXT
  summary: 'ROCm Device libraries'

extra:
  recipe-maintainers:
    - isuruf
    - zklaus
    - conda-forge/rocm-core
